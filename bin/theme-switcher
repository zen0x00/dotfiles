#!/bin/bash
THEMES="$HOME/.config/themes"
CURRENT="$THEMES/current"
THEME=$(ls "$THEMES" | grep -v current | rofi -dmenu -p "Theme")
[ -z "$THEME" ] && exit

ln -sfn "$THEMES/$THEME" "$CURRENT"

GTK_SRC="$CURRENT/gtk/settings.ini"

if [[ -f "$GTK_SRC" ]]; then
  GTK_THEME=$(awk -F= '/gtk-theme-name/ {gsub(/[[:space:]]*/, "", $2); print $2}' "$GTK_SRC")
  GTK_ICON=$(awk -F= '/gtk-icon-theme-name/ {gsub(/[[:space:]]*/, "", $2); print $2}' "$GTK_SRC")

  for DIR in "$HOME/.config/gtk-3.0" "$HOME/.config/gtk-4.0"; do
    SETTINGS="$DIR/settings.ini"
    mkdir -p "$DIR"
    [[ -f "$SETTINGS" ]] || echo -e "[Settings]\n" > "$SETTINGS"

    if ! grep -q '^\[Settings\]' "$SETTINGS"; then
      echo "[Settings]" >> "$SETTINGS"
    fi

    if [[ -n "$GTK_THEME" ]]; then
      if grep -q '^gtk-theme-name' "$SETTINGS"; then
        sed -i -E "s/^gtk-theme-name=.*/gtk-theme-name=$GTK_THEME/" "$SETTINGS"
      else
        echo "gtk-theme-name=$GTK_THEME" >> "$SETTINGS"
      fi
      if [[ "$GTK_THEME" == *"latte"* ]]; then
        gsettings set org.gnome.desktop.interface color-scheme 'prefer-light'
      else
        gsettings set org.gnome.desktop.interface color-scheme 'prefer-dark'
      fi
      gsettings set org.gnome.desktop.interface gtk-theme "$GTK_THEME"
    fi
    


    if [[ -n "$GTK_ICON" ]]; then
      if grep -q '^gtk-icon-theme-name' "$SETTINGS"; then
        sed -i -E "s/^gtk-icon-theme-name=.*/gtk-icon-theme-name=$GTK_ICON/" "$SETTINGS"
      else
        echo "gtk-icon-theme-name=$GTK_ICON" >> "$SETTINGS"
      fi
      gsettings set org.gnome.desktop.interface icon-theme "$GTK_ICON"
    fi
  done
fi

LIBADWAITA_SRC="$HOME/.local/share/themes/$GTK_THEME/gtk-4.0/gtk.css"

if [[ -f "$LIBADWAITA_SRC" ]]; then
  mkdir -p "$HOME/.config/gtk-4.0"
  ln -sf "$LIBADWAITA_SRC" "$HOME/.config/gtk-4.0/gtk.css"
  ln -sf "$LIBADWAITA_SRC" "$HOME/.config/gtk-4.0/gtk-dark.css"
fi

zen0x-theme-set-vscode

CACHE="$HOME/.cache/wallpaper_thumbs/$THEME"
WALLDIR="$THEMES/$THEME/wallpapers"

mkdir -p "$CACHE"

find -L "$WALLDIR" -type f \( \
  -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" \
\) | while read -r img; do
  thumb="$CACHE/$(echo "$img" | md5sum | cut -d' ' -f1).png"
  [[ -f "$thumb" ]] && continue
  magick "$img" \
    -resize 440x225^ \
    -gravity center \
    -extent 440x225 \
    "$thumb" &
done

wait

awww img "$CURRENT/wallpapers/wallpaper.jpg" --transition-type grow --transition-duration 1 --transition-fps 60

ln -sf "$CURRENT/wallpapers/wallpaper.jpg" "$HOME/.current_wallpaper"

pkill waybar
pkill swaync
waybar &
swaync &
hyprctl reload
